---
phase: 02-error-handling-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/bin/gsd-tools.js
autonomous: true

must_haves:
  truths:
    - "A structured error class hierarchy exists with GsdError as base and ValidationError, FileSystemError, ConfigError, PhaseError as subclasses"
    - "Each error class carries a numeric code property mapping to POSIX exit codes (0=success, 1=error, 2=usage, 3=config, 4=filesystem)"
    - "The error() function uses error class codes to set process.exit code instead of hardcoded 1"
    - "All existing tests still pass with identical stdout behavior"
  artifacts:
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "Error class hierarchy and POSIX exit codes"
      contains: "class GsdError extends Error"
  key_links:
    - from: "error() function"
      to: "GsdError subclasses"
      via: "exit code from error.code property"
      pattern: "process\\.exit\\(.*\\.code\\b|process\\.exit\\([0-4]\\)"
---

<objective>
Create a structured error class hierarchy and POSIX-compliant exit codes in gsd-tools.js.

Purpose: Foundation for all other Phase 2 plans. Error classes are used by catch block fixes (Plan 03) and input validation (Plan 04). Exit codes enable callers (orchestrators, workflows) to distinguish error types programmatically.
Output: Error classes and refactored error/output functions in gsd-tools.js.
</objective>

<execution_context>
@/Users/naveennegi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/naveennegi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@get-shit-done/bin/gsd-tools.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create error class hierarchy and POSIX exit code constants</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
    Add error class hierarchy near the top of gsd-tools.js (after the require statements, before the MODEL_PROFILES table).

    Define exit code constants:
    ```
    const EXIT_SUCCESS = 0;
    const EXIT_ERROR = 1;
    const EXIT_USAGE = 2;
    const EXIT_CONFIG = 3;
    const EXIT_FILESYSTEM = 4;
    ```

    Define error classes:
    ```
    class GsdError extends Error {
      constructor(message, code = EXIT_ERROR) {
        super(message);
        this.name = 'GsdError';
        this.code = code;
      }
    }
    class ValidationError extends GsdError {
      constructor(message) { super(message, EXIT_USAGE); this.name = 'ValidationError'; }
    }
    class FileSystemError extends GsdError {
      constructor(message) { super(message, EXIT_FILESYSTEM); this.name = 'FileSystemError'; }
    }
    class ConfigError extends GsdError {
      constructor(message) { super(message, EXIT_CONFIG); this.name = 'ConfigError'; }
    }
    class PhaseError extends GsdError {
      constructor(message) { super(message, EXIT_ERROR); this.name = 'PhaseError'; }
    }
    ```

    These classes are defined inline in gsd-tools.js (no separate module) following the existing monolith pattern. Phase 3 (decomposition) will extract them later.
  </action>
  <verify>Run `node --test get-shit-done/bin/gsd-tools.test.js` -- all existing tests must pass unchanged. The classes are additive and don't change any existing behavior yet.</verify>
  <done>Error class hierarchy exists in gsd-tools.js with GsdError base class and 4 subclasses, each with appropriate POSIX exit code.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor error() and output() functions to use POSIX exit codes</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
    Refactor the `error()` function (currently at ~line 475) to accept an optional exit code parameter:
    ```
    function error(message, code = EXIT_ERROR) {
      process.stderr.write('Error: ' + message + '\n');
      process.exit(code);
    }
    ```

    Then update specific error() call sites to use appropriate exit codes. Apply these categories:

    EXIT_USAGE (2) -- bad user input:
    - "text required for slug generation"
    - "file path required"
    - "file, field, and value required"
    - "file and data required"
    - "At least one commit hash required"
    - All "Unknown ... subcommand" messages
    - "Phase number required"
    - "Description required"
    - All missing required parameter errors

    EXIT_CONFIG (3) -- configuration problems:
    - "STATE.md not found"
    - "ROADMAP.md not found"
    - ".planning directory not found"
    - "config.json" related errors

    EXIT_FILESYSTEM (4) -- file system issues:
    - File not found errors for user-specified paths
    - Directory not found errors

    EXIT_ERROR (1) -- general errors (default, unchanged):
    - Git failures
    - Unexpected internal errors

    IMPORTANT: Do NOT change the stderr message format ("Error: " prefix). Only change the exit code number. This preserves backward compatibility for any callers parsing stderr.

    Count: There are approximately 3 process.exit() calls and ~40+ error() calls. Update only the error() signature and the ~15-20 call sites where the category is clearly not EXIT_ERROR.
  </action>
  <verify>Run `node --test get-shit-done/bin/gsd-tools.test.js` -- all tests must pass. Tests that check for non-zero exit codes (exit code 1) should still pass because EXIT_ERROR=1 is the default. Tests that check for specific stderr messages will pass because message format is unchanged.</verify>
  <done>error() function accepts optional exit code, ~15-20 call sites updated to use EXIT_USAGE/EXIT_CONFIG/EXIT_FILESYSTEM, all existing tests pass.</done>
</task>

</tasks>

<verification>
1. `node --test get-shit-done/bin/gsd-tools.test.js` passes all existing tests
2. `node -e "require('./get-shit-done/bin/gsd-tools.js')"` does not error (module still loadable -- it uses require.main guard)
3. `node get-shit-done/bin/gsd-tools.js generate-slug; echo $?` returns exit code 2 (usage error for missing arg)
4. `node get-shit-done/bin/gsd-tools.js state load; echo $?` returns exit code 3 (config error when no .planning/)
</verification>

<success_criteria>
- GsdError, ValidationError, FileSystemError, ConfigError, PhaseError classes exist
- Exit codes follow POSIX convention: 0=success, 1=error, 2=usage, 3=config, 4=filesystem
- error() function signature includes optional code parameter
- All existing characterization tests pass unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/02-error-handling-security/02-01-SUMMARY.md`
</output>
