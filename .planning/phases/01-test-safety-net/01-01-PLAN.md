---
phase: 01-test-safety-net
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/install.js
  - bin/install.test.js
autonomous: true

must_haves:
  truths:
    - "install.js pure functions can be imported via require() without triggering the interactive installer"
    - "JSONC parser handles edge cases (nested comments, escaped quotes, BOM, trailing commas, malformed input) without crashing"
    - "Frontmatter conversion produces correct output for all 3 runtime formats (Claude->OpenCode, Claude->Gemini agent, Claude->Gemini TOML)"
    - "Tool name mapping correctly translates between Claude, OpenCode, and Gemini tool names in both directions"
  artifacts:
    - path: "bin/install.js"
      provides: "Module exports guard for testability"
      contains: "require.main === module"
    - path: "bin/install.test.js"
      provides: "Pure function unit tests for install.js"
      min_lines: 300
  key_links:
    - from: "bin/install.test.js"
      to: "bin/install.js"
      via: "require('./install.js')"
      pattern: "require\\('./install"
---

<objective>
Add a module.exports guard to install.js and create comprehensive unit tests for all its pure functions -- JSONC parser, frontmatter converters, and tool name mappers.

Purpose: Enable direct testing of install.js internals (currently 0% coverage) and capture the exact behavior of the JSONC parser and frontmatter conversion functions that subsequent phases will refactor. This is the highest-value testing target because install.js is the first user touchpoint and has zero test coverage.

Output: `bin/install.test.js` with 45-55 tests covering all 12 pure functions.
</objective>

<execution_context>
@/Users/naveennegi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/naveennegi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@bin/install.js
@get-shit-done/bin/gsd-tools.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add module.exports guard to install.js and create install.test.js scaffold</name>
  <files>bin/install.js, bin/install.test.js</files>
  <action>
  1. In `bin/install.js`, wrap the existing main logic (lines ~1704-1739, starting at `// Main logic`) inside a `if (require.main === module) { ... }` guard. Add an `else` block that exports all pure functions for testing:

  ```javascript
  if (require.main === module) {
    // ... existing main logic (if/else chain for hasGlobal, hasLocal, etc.)
  } else {
    module.exports = {
      parseJsonc, convertClaudeToOpencodeFrontmatter, convertClaudeToGeminiAgent,
      convertClaudeToGeminiToml, convertToolName, convertGeminiToolName,
      stripSubTags, expandTilde, processAttribution, getDirName, getGlobalDir,
      buildHookCommand
    };
  }
  ```

  This is the ONLY production code change in Phase 1. It does not alter any behavior -- it only adds testability. The `require.main === module` pattern is standard Node.js.

  2. Create `bin/install.test.js` with the standard test scaffold matching the existing gsd-tools.test.js pattern:
  - Import `node:test`, `node:assert`, `fs`, `path`, `os`
  - `require('./install.js')` to import the pure functions
  - Verify the import works without triggering the installer (this is the key validation that the guard works)

  Verify: `node -e "const m = require('./bin/install.js'); console.log(Object.keys(m))"` should print the function names without triggering the installer banner or prompts.
  </action>
  <verify>
  Run `node -e "const m = require('./bin/install.js'); console.log(Object.keys(m))"` and confirm it prints an array of function names without any interactive prompts or installer output.
  Run `node bin/install.js --help` (or equivalent) to confirm the installer still works normally when invoked directly.
  </verify>
  <done>install.js exports its pure functions when required as a module, and the installer still works when run directly via `node bin/install.js`.</done>
</task>

<task type="auto">
  <name>Task 2: Write JSONC parser edge case tests (TEST-03)</name>
  <files>bin/install.test.js</files>
  <action>
  Add a `describe('parseJsonc', ...)` block to `bin/install.test.js` with 8-10 tests covering:

  1. **Single-line comments**: `{ "key": "val" // comment }` strips comment
  2. **Block comments**: `{ /* comment */ "key": "val" }` strips comment
  3. **Nested block comments**: `{ "a": /* outer /* not nested */ "val" }` handles correctly
  4. **Strings containing comment-like sequences**: `{ "url": "https://example.com" }` preserves `//` in strings
  5. **Escaped quotes inside strings**: `{ "key": "value with \\"quotes\\"" }` handles correctly
  6. **UTF-8 BOM prefix**: `\uFEFF{"key": "val"}` strips BOM and parses
  7. **Trailing commas before closing brace**: `{ "a": 1, "b": 2, }` removes trailing comma
  8. **Trailing commas before closing bracket**: `{ "arr": [1, 2, 3, ] }` removes trailing comma
  9. **Malformed JSON after stripping**: `{ broken }` throws SyntaxError
  10. **Empty input**: `""` or `"{}"` handles gracefully
  11. **Multi-line comments spanning lines**: Comment across multiple lines stripped correctly

  Use `assert.deepStrictEqual` for parsed output and `assert.throws` for error cases. Import `parseJsonc` from `require('./install.js')`.
  </action>
  <verify>Run `node --test bin/install.test.js --test-name-pattern "parseJsonc"` and confirm all tests pass.</verify>
  <done>JSONC parser has 8-10 edge case tests covering nested comments, escaped quotes, BOM, trailing commas, and malformed input, all passing.</done>
</task>

<task type="auto">
  <name>Task 3: Write frontmatter converter and tool mapper tests (TEST-04)</name>
  <files>bin/install.test.js</files>
  <action>
  Add describe blocks for each converter function:

  **`describe('convertClaudeToOpencodeFrontmatter', ...)`** (5-7 tests):
  1. Converts `allowed-tools` array to `tools` object with `read: true`, `write: true` etc.
  2. Maps special tool names correctly: `AskUserQuestion` -> `question`, `SlashCommand` -> `skill`, `TodoWrite` -> `todowrite`
  3. Strips `name:` field (OpenCode doesn't use it)
  4. Converts color names to hex (e.g., `cyan` -> `"#00FFFF"`)
  5. Preserves body content after frontmatter
  6. Handles `tools:` inline format (comma-separated) vs `allowed-tools:` array format
  7. MCP tools (mcp__*) are included correctly

  **`describe('convertClaudeToGeminiAgent', ...)`** (5-7 tests):
  1. Converts tools to YAML array with Gemini names (`Read` -> `read_file`, `Write` -> `write_file`, `Bash` -> `run_shell_command`)
  2. Excludes MCP tools (mcp__*) from Gemini output
  3. Excludes `Task` tool from Gemini output
  4. Strips `color:` field
  5. Preserves body content
  6. Handles empty tools list

  **`describe('convertClaudeToGeminiToml', ...)`** (3-4 tests):
  1. Extracts description and body as TOML format
  2. Handles multi-line body content
  3. Handles description with special characters (quotes)

  **`describe('convertToolName', ...)`** (3-4 tests):
  1. Maps Claude tool names to OpenCode equivalents
  2. Returns lowercase for unmapped tools
  3. Handles MCP tool prefix

  **`describe('convertGeminiToolName', ...)`** (3-4 tests):
  1. Maps Claude tool names to Gemini equivalents
  2. Returns null or skips for unsupported tools (MCP, Task)
  3. Maps common tools correctly

  **`describe('utility functions', ...)`** (5-7 tests for stripSubTags, expandTilde, getDirName, buildHookCommand):
  1. `stripSubTags`: Removes sub-tags from content, preserves non-sub content
  2. `expandTilde`: Replaces `~` with home directory
  3. `getDirName`: Returns `.claude`, `.opencode`, `.gemini` for respective runtimes
  4. `buildHookCommand`: Constructs correct hook command path

  Total: ~25-30 tests in this task.
  </action>
  <verify>Run `node --test bin/install.test.js` and confirm all tests pass. Verify test count is 35+ (JSONC + converters + utilities combined).</verify>
  <done>Frontmatter conversion tested for all 3 runtime formats, tool name mapping tested in both directions, utility functions tested. Total install.test.js has 45+ passing tests.</done>
</task>

</tasks>

<verification>
1. `node -e "require('./bin/install.js')"` works silently (no installer output)
2. `node --test bin/install.test.js` passes with 45+ tests
3. `node bin/install.js --claude --global` still works as before (installer not broken)
4. All JSONC edge cases from TEST-03 have dedicated test assertions
5. All 3 frontmatter converters from TEST-04 have dedicated test assertions
</verification>

<success_criteria>
- install.js exports pure functions when required as a module
- parseJsonc has 8+ edge case tests covering all scenarios in TEST-03
- All 3 frontmatter converters have tests per TEST-04
- Tool name mapping tested in both directions
- 45+ tests passing in bin/install.test.js
- Existing installer behavior unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/01-test-safety-net/01-01-SUMMARY.md`
</output>
