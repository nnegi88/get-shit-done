---
phase: 01.1-migrate-gsd-from-subagents-to-agent-teams
plan: 02
type: execute
wave: 2
depends_on: [01.1-01]
files_modified:
  - ~/.claude/get-shit-done/workflows/plan-phase.md
autonomous: true

must_haves:
  truths:
    - "Plan-phase workflow creates a team with researcher, planner, and checker teammates"
    - "Planner can message researcher for follow-up questions during planning"
    - "Checker messages planner directly with issues instead of returning to orchestrator"
    - "Planner and checker collaborate directly in revision loop without orchestrator bottleneck"
    - "Workflow falls back to sequential subagent spawning if TeamCreate fails"
    - "All existing plan-phase functionality preserved (init, research, planning, checking, revision loop max 3, offer_next)"
  artifacts:
    - path: "~/.claude/get-shit-done/workflows/plan-phase.md"
      provides: "Team-based planning workflow with direct messaging between researcher/planner/checker"
      contains: "TeamCreate"
  key_links:
    - from: "~/.claude/get-shit-done/workflows/plan-phase.md"
      to: "~/.claude/agents/gsd-planner.md"
      via: "Task() spawn with team_name parameter"
      pattern: "team_name.*gsd-plan"
    - from: "~/.claude/get-shit-done/workflows/plan-phase.md"
      to: "~/.claude/agents/gsd-phase-researcher.md"
      via: "Task() spawn with team_name parameter"
      pattern: "team_name.*gsd-plan"
    - from: "~/.claude/get-shit-done/workflows/plan-phase.md"
      to: "~/.claude/agents/gsd-plan-checker.md"
      via: "Task() spawn with team_name parameter"
      pattern: "team_name.*gsd-plan"
---

<objective>
Migrate the plan-phase.md workflow from sequential subagent spawning to Agent Teams orchestration with direct messaging between researcher, planner, and checker.

Purpose: This is the highest-value migration. The current plan-phase workflow spawns 3 agents sequentially with file-only handoffs. With Agent Teams, the planner can ask the researcher follow-up questions, the checker can message the planner directly, and the revision loop eliminates the orchestrator bottleneck. Graceful fallback ensures resilience.

Output: Rewritten plan-phase.md workflow with team orchestration and subagent fallback.
</objective>

<execution_context>
@/Users/naveennegi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/naveennegi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.1-migrate-gsd-from-subagents-to-agent-teams/01.1-RESEARCH.md
@.planning/phases/01.1-migrate-gsd-from-subagents-to-agent-teams/CONTEXT.md
@.planning/phases/01.1-migrate-gsd-from-subagents-to-agent-teams/01.1-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite plan-phase.md for team orchestration with graceful fallback</name>
  <files>
    ~/.claude/get-shit-done/workflows/plan-phase.md
  </files>
  <action>
    Rewrite `plan-phase.md` to use Agent Teams while preserving ALL existing functionality. The workflow must attempt team-based orchestration and fall back to the current sequential subagent pattern if teams are unavailable.

    **Structure of the rewritten workflow:**

    Keep the existing `<purpose>`, `<required_reading>`, and `<success_criteria>` sections with updates to reflect team mode.

    **Steps 1-4 remain IDENTICAL** (Initialize, Parse Arguments, Validate Phase, Load CONTEXT.md). No changes to init loading, argument parsing, phase validation, or context loading.

    **Step 5 (Handle Research) — restructured for team context:**

    After research decision is made (skip or do), if research is needed AND team mode:
    - The researcher will be spawned as a teammate (step 8 creates the team with all agents at once)
    - Research still produces RESEARCH.md file as before

    **Steps 6-7 remain IDENTICAL** (Check Existing Plans, Use Context Files from INIT).

    **Step 8 (NEW) — Team Creation with Fallback:**

    ```
    ## 8. Create Planning Team (or Fall Back to Subagents)

    **Attempt team creation:**

    ```
    TeamCreate({ team_name: "gsd-plan-{phase_number}", description: "Planning team for Phase {phase_number}: {phase_name}" })
    ```

    **If TeamCreate succeeds — TEAM MODE:**

    Create tasks with dependency chain:

    ```
    # Only if research is needed (not skipped, not existing)
    TaskCreate({
      subject: "Research phase {phase_number} domain",
      description: "Investigate technical domain for Phase {phase_number}. Write RESEARCH.md to {phase_dir}/{phase}-RESEARCH.md",
      activeForm: "Researching phase domain"
    })
    # Returns task ID (e.g., "1")

    TaskCreate({
      subject: "Create execution plans for phase {phase_number}",
      description: "Create PLAN.md files based on research and context. Phase dir: {phase_dir}",
      activeForm: "Creating execution plans",
      addBlockedBy: ["1"]  # blocked by research (omit if research skipped)
    })
    # Returns task ID (e.g., "2")

    TaskCreate({
      subject: "Verify plan quality for phase {phase_number}",
      description: "Check plans against phase goal using 7 verification dimensions. Plans dir: {phase_dir}",
      activeForm: "Verifying plan quality",
      addBlockedBy: ["2"]  # blocked by planning
    })
    # Returns task ID (e.g., "3")
    ```

    Spawn teammates:

    ```
    # Only if research is needed
    Task(
      team_name: "gsd-plan-{phase_number}",
      name: "researcher",
      subagent_type: "gsd-phase-researcher",
      prompt: "First, read /Users/naveennegi/.claude/agents/gsd-phase-researcher.md for your role and instructions.\n\nYou are the researcher on a planning team. Check TaskList() for your task. Claim it and begin research.\n\n" + research_prompt_from_step_5
    )

    Task(
      team_name: "gsd-plan-{phase_number}",
      name: "planner",
      subagent_type: "general-purpose",
      prompt: "First, read /Users/naveennegi/.claude/agents/gsd-planner.md for your role and instructions.\n\nYou are the planner on a planning team. Check TaskList() for your task. It is blocked until research completes. When unblocked, claim it and begin planning.\n\nIMPORTANT: If the researcher messages you with findings or you need clarification, use SendMessage to communicate directly.\n\n" + planner_prompt_from_step_8
    )

    Task(
      team_name: "gsd-plan-{phase_number}",
      name: "checker",
      subagent_type: "gsd-plan-checker",
      prompt: "First, read /Users/naveennegi/.claude/agents/gsd-plan-checker.md for your role and instructions.\n\nYou are the checker on a planning team. Check TaskList() for your task. It is blocked until planning completes. When unblocked, claim it and verify.\n\nIMPORTANT: Send issues directly to the planner via SendMessage. The planner will revise and message you back for re-verification. This is a direct collaboration — no orchestrator intermediary.\n\n" + checker_prompt_from_step_10
    )
    ```

    **Monitoring in team mode:**

    The orchestrator monitors via TaskList(). When the checker's task completes with "VERIFICATION PASSED" or after max 3 revision iterations between checker and planner:

    ```
    # Shutdown sequence
    SendMessage({ type: "shutdown_request", recipient: "researcher", content: "Planning complete" })
    SendMessage({ type: "shutdown_request", recipient: "planner", content: "Planning complete" })
    SendMessage({ type: "shutdown_request", recipient: "checker", content: "Planning complete" })
    # Wait for shutdown_response from each
    TeamDelete()
    ```

    **If TeamCreate fails — FALLBACK to current sequential mode:**

    Display: `Agent Teams unavailable. Using sequential subagent mode.`

    Execute the EXACT current workflow steps 5-12 (sequential Task() spawning for researcher, planner, checker, revision loop). This is the existing code — preserve it verbatim as the fallback path.

    **Step 13 (Present Final Status) — unchanged.** Same `<offer_next>` section.

    **Key behavioral changes in team mode vs current:**

    | Aspect | Current (Subagent) | New (Team Mode) |
    |--------|-------------------|-----------------|
    | Researcher-Planner | File handoff only | Direct messaging + file |
    | Checker-Planner revision | Orchestrator mediates | Direct planner<->checker messaging |
    | Revision loop | Orchestrator spawns new agents each iteration | Same agents, persistent sessions, direct messages |
    | Max iterations | 3 (orchestrator counts) | 3 (planner/checker self-manage, team lead monitors) |
    | Research skip | --skip-research flag | Same flag, researcher not spawned in team |
    | Fallback | N/A | Full subagent fallback if TeamCreate fails |

    **CRITICAL: The revision loop in team mode works differently:**

    In team mode, the checker and planner handle the revision loop directly via SendMessage. The revision loop counter (max 3) should be communicated to both planner and checker in their spawn prompts. The checker sends issues to the planner, the planner revises and notifies the checker, the checker re-verifies. After 3 iterations OR verification passed, the checker updates its task as completed with the final status.

    The orchestrator monitors progress via TaskList() and handles the offer_next once all tasks are complete.

    **Preserve these existing behaviors exactly:**
    - Init loading and context assembly (steps 1-4, 6-7)
    - --gaps flag handling
    - --skip-research and --research flags
    - --skip-verify flag
    - research_enabled and plan_checker_enabled config checks
    - All banner displays
    - offer_next format
    - success_criteria section
  </action>
  <verify>
    1. `grep "TeamCreate" ~/.claude/get-shit-done/workflows/plan-phase.md` finds team creation
    2. `grep "SendMessage" ~/.claude/get-shit-done/workflows/plan-phase.md` finds messaging instructions
    3. `grep "team_name" ~/.claude/get-shit-done/workflows/plan-phase.md` finds teammate spawning
    4. `grep "TeamDelete" ~/.claude/get-shit-done/workflows/plan-phase.md` finds cleanup
    5. `grep "fallback\|FALLBACK\|subagent mode\|sequential mode" ~/.claude/get-shit-done/workflows/plan-phase.md` finds fallback path
    6. The file still contains steps 1-4 (init, parse args, validate phase, load context) unchanged
    7. The file still contains the `<offer_next>` section
  </verify>
  <done>
    plan-phase.md creates a planning team with researcher, planner, and checker teammates. Planner can ask researcher follow-up questions via SendMessage. Checker and planner collaborate directly in revision loop (max 3 iterations) without orchestrator bottleneck. If TeamCreate fails, workflow falls back to the exact current sequential subagent pattern. All existing functionality (flags, configs, banners, offer_next) is preserved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate team mode revision loop is documented with iteration limits</name>
  <files>
    ~/.claude/get-shit-done/workflows/plan-phase.md
  </files>
  <action>
    After Task 1 rewrites plan-phase.md, validate and refine the team-mode revision loop section to ensure:

    1. **Iteration limit is explicit in team mode:** The spawn prompts for both planner and checker must include:
       ```
       Revision loop limit: Maximum 3 iterations. Track iteration count.
       - Iteration 1: Checker verifies initial plans, sends issues to planner
       - Iteration 2: Planner revises, notifies checker; checker re-verifies
       - Iteration 3: Final revision if needed
       After 3 iterations: Checker marks task completed with remaining issues in the completion message.
       ```

    2. **Orchestrator monitoring in team mode:** The orchestrator section must describe how it monitors the revision loop:
       ```
       Monitor team progress:
       - Use TaskList() periodically to check task statuses
       - When checker's task transitions to "completed", read the checker's final message
       - If status is "VERIFICATION PASSED": proceed to shutdown and offer_next
       - If status is "ISSUES REMAIN" after max iterations: present remaining issues to user (same as current step 12 max-iteration handling)
       ```

    3. **User interaction in team mode:** If max iterations reached and issues remain, the orchestrator presents the same options as current step 12:
       - Force proceed
       - Provide guidance and retry
       - Abandon

    4. **Verify that the --skip-verify path correctly skips checker spawning in team mode** (just researcher + planner, no checker task or teammate).

    5. **Verify that when plan_checker_enabled is false, the checker is not spawned** even in team mode.

    Read the plan-phase.md file after Task 1 modifications and make any necessary adjustments to ensure these behaviors are clearly documented.
  </action>
  <verify>
    1. The file contains "Maximum 3 iterations" or equivalent iteration limit language in the team mode section
    2. The file describes orchestrator monitoring via TaskList()
    3. The file handles max-iterations-reached case in team mode (same user options as current)
    4. --skip-verify path works in both team and fallback modes
    5. plan_checker_enabled=false path works in both modes
  </verify>
  <done>
    The team mode revision loop in plan-phase.md has explicit iteration limits (max 3), orchestrator monitoring via TaskList(), and graceful handling of max-iterations-reached (same user options as current workflow). Skip-verify and plan_checker_enabled paths work correctly in both team and fallback modes.
  </done>
</task>

</tasks>

<verification>
1. plan-phase.md supports both team mode (TeamCreate -> spawn teammates -> monitor -> shutdown -> TeamDelete) and fallback mode (current sequential Task() spawning)
2. Team mode enables: researcher-planner direct messaging, checker-planner direct revision loop
3. Revision loop has max 3 iterations in both modes
4. All flags (--gaps, --skip-research, --research, --skip-verify) work in both modes
5. All config checks (research_enabled, plan_checker_enabled) work in both modes
6. Existing init loading, context assembly, banners, and offer_next are preserved
</verification>

<success_criteria>
The plan-phase workflow creates a planning team where planner can ask researcher follow-up questions and checker collaborates directly with planner on revisions, with graceful fallback to sequential subagent mode.
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-migrate-gsd-from-subagents-to-agent-teams/01.1-02-SUMMARY.md`
</output>
