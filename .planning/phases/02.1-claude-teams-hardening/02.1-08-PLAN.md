---
phase: 02.1-claude-teams-hardening
plan: 08
type: execute
wave: 3
depends_on: ["02.1-06"]
files_modified:
  - get-shit-done/bin/gsd-tools.js
  - get-shit-done/workflows/execute-phase.md
  - agents/gsd-executor.md
autonomous: true

must_haves:
  truths:
    - "Orchestrator state persists to .planning/.orchestrator-state.json and can be reconstructed on restart"
    - "On restart, the orchestrator reads persisted state and resumes coordination without re-creating already-running executors"
    - "Executors have a lost leader protocol: if they cannot reach the orchestrator, they continue execution autonomously and persist results to files"
  artifacts:
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "orchestrator-state write/read commands"
      contains: "orchestrator-state"
    - path: "get-shit-done/workflows/execute-phase.md"
      provides: "State persistence and reconstruction on restart, lost leader detection"
      contains: "orchestrator-state"
    - path: "agents/gsd-executor.md"
      provides: "Lost leader graceful degradation protocol"
      contains: "lost.leader"
  key_links:
    - from: "get-shit-done/workflows/execute-phase.md"
      to: "get-shit-done/bin/gsd-tools.js"
      via: "Orchestrator persists state periodically and reads on restart"
      pattern: "orchestrator-state"
    - from: "agents/gsd-executor.md"
      to: "get-shit-done/workflows/execute-phase.md"
      via: "Executor detects lost leader and switches to autonomous mode"
      pattern: "lost.leader"
---

<objective>
Persist orchestrator state to disk and add a "lost leader" protocol so executors can degrade gracefully if the orchestrator crashes.

Purpose: If the orchestrator itself crashes, all progress is lost and teammates are orphaned. Persisted state enables reconstruction, and the lost leader protocol ensures executors finish their work even without coordination.
Output: New gsd-tools.js orchestrator-state commands, execute-phase.md state persistence/reconstruction, and gsd-executor.md lost leader protocol.
</objective>

<execution_context>
@/Users/naveennegi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/naveennegi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-claude-teams-hardening/02.1-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add orchestrator-state write/read commands to gsd-tools.js</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Add two new subcommands under an `orchestrator-state` command group:

1. **`orchestrator-state write --phase <phase> --mode <team|fallback> --data <json_string>`**
   - Writes/updates `.planning/.orchestrator-state.json`
   - Uses atomic write (write to temp file, rename) to prevent corruption
   - File structure:
     ```json
     {
       "phase": "02.1-claude-teams-hardening",
       "mode": "team",
       "team_name": "gsd-exec-02.1",
       "started_at": "ISO",
       "updated_at": "ISO",
       "plan_task_map": { "02.1-01": "task-1", "02.1-02": "task-2" },
       "executor_names": ["executor-02.1-01", "executor-02.1-02"],
       "verifier_task_id": "task-5",
       "completed_plans": ["02.1-01"],
       "current_wave": 1,
       "checkpoint_file": ".planning/.team-checkpoint.json"
     }
     ```
   - The --data parameter accepts a JSON string with the fields to write/update
   - Merges with existing state (doesn't overwrite unless specified)

2. **`orchestrator-state read`**
   - Reads `.planning/.orchestrator-state.json`
   - Returns full JSON content
   - If file doesn't exist: `{ exists: false }`

3. **`orchestrator-state clear`**
   - Removes `.planning/.orchestrator-state.json`
   - Returns `{ cleared: true }`

Register in command dispatch. Use atomic write for state persistence to prevent corruption mid-write.
  </action>
  <verify>
Run orchestrator-state commands:
```bash
node gsd-tools.js orchestrator-state write --phase "02.1" --mode team --data '{"team_name":"gsd-exec-02.1","executor_names":["exec-01"]}'
node gsd-tools.js orchestrator-state read
node gsd-tools.js orchestrator-state clear
```
Verify JSON structure and atomic write. Run `npm test`.
  </verify>
  <done>orchestrator-state write/read/clear commands persist and retrieve orchestrator coordination state with atomic writes.</done>
</task>

<task type="auto">
  <name>Task 2: Add state persistence to execute-phase.md and lost leader protocol to gsd-executor.md</name>
  <files>get-shit-done/workflows/execute-phase.md, agents/gsd-executor.md</files>
  <action>
In `execute-phase.md`:

1. **State persistence — after team creation and task setup:**
   ```bash
   node gsd-tools.js orchestrator-state write --phase "{phase}" --mode team --data '{
     "team_name": "{team_name}",
     "plan_task_map": {plan_to_task_mapping},
     "executor_names": [{executor_names}],
     "verifier_task_id": "{verifier_task_id}",
     "completed_plans": [],
     "current_wave": 1
   }'
   ```

2. **State update — in monitoring loop after each plan completes:**
   ```bash
   node gsd-tools.js orchestrator-state write --phase "{phase}" --mode team --data '{
     "completed_plans": [{updated list}],
     "current_wave": {current_wave}
   }'
   ```

3. **State reconstruction — at the start of execute_waves, check for existing state:**
   ```
   ORCH_STATE=$(node gsd-tools.js orchestrator-state read)
   if orch_state.exists AND orch_state.phase == current_phase:
     Display: "Found persisted orchestrator state for Phase {phase}"
     Display: "Mode: {mode}, {completed_count} plans already completed"
     # Use team-checkpoint.json (from Plan 06) for plan completion status
     # Create new team for remaining plans (existing executors are gone on crash)
     # Skip completed plans in task creation
   ```

4. **Cleanup — after successful completion:**
   ```bash
   node gsd-tools.js orchestrator-state clear
   ```

In `gsd-executor.md`, add a new section after `<team_communication_protocol>`:

```markdown
<lost_leader_protocol>
## Lost Leader Graceful Degradation

If you detect the orchestrator (team lead) is unresponsive:

**Detection signals:**
- SendMessage to team-lead fails or times out
- No response to checkpoint escalation after extended wait
- Team operations start failing

**Graceful degradation steps:**
1. **Continue executing your current plan autonomously** — do NOT stop work
2. **Write all artifacts normally** (SUMMARY.md, commits, STATE.md updates)
3. **Write heartbeat and progress** — a restarted orchestrator can pick these up
4. **Update team checkpoint** on completion:
   \```bash
   node gsd-tools.js team-checkpoint write --phase "{phase}" --plan "{plan_id}" --status completed
   \```
5. **Skip UNBLOCKED notifications** (downstream executors may also be orphaned)
6. **On plan completion:** Attempt to mark team task as completed. If it fails, just ensure SUMMARY.md exists on disk — the file-based state layer is the ultimate fallback

**Rationale:** Files survive orchestrator crashes. A restarted orchestrator reads SUMMARY.md files and checkpoint data to reconstruct state. Your work is never lost if committed to git and written to files.
</lost_leader_protocol>
```
  </action>
  <verify>
Read execute-phase.md and verify: state persistence after setup, state updates in monitoring, state reconstruction on restart, cleanup on completion. Read gsd-executor.md and verify lost_leader_protocol section with degradation steps.
  </verify>
  <done>Orchestrator persists state to disk and reconstructs on restart. Executors degrade gracefully with lost leader protocol, ensuring work is preserved via files.</done>
</task>

</tasks>

<verification>
1. `npm test` passes with no regressions
2. orchestrator-state commands work with atomic writes
3. execute-phase.md persists state at key points and reconstructs on restart
4. gsd-executor.md has lost leader protocol with degradation steps
5. File-based artifacts are the ultimate fallback (SUMMARY.md, commits, checkpoint)
</verification>

<success_criteria>
Orchestrator state persists to disk and reconstructs on restart, with executors having a "lost leader" graceful degradation protocol.
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-claude-teams-hardening/02.1-08-SUMMARY.md`
</output>
