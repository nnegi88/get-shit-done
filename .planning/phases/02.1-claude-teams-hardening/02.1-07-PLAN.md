---
phase: 02.1-claude-teams-hardening
plan: 07
type: execute
wave: 2
depends_on: ["02.1-04"]
files_modified:
  - get-shit-done/bin/gsd-tools.js
  - agents/gsd-executor.md
  - get-shit-done/workflows/execute-phase.md
autonomous: true

must_haves:
  truths:
    - "Stale executor heartbeats (>15 min since last update) trigger a health-check message from the orchestrator"
    - "If the executor doesn't respond to the health-check, a replacement executor is spawned"
    - "Executors write heartbeats after each task completion alongside progress updates"
  artifacts:
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "heartbeat write/read/check-stale commands"
      contains: "heartbeat"
    - path: "agents/gsd-executor.md"
      provides: "Heartbeat writing behavior for executors"
      contains: "heartbeat"
    - path: "get-shit-done/workflows/execute-phase.md"
      provides: "Stale heartbeat detection and replacement spawning in monitoring loop"
      contains: "heartbeat"
  key_links:
    - from: "agents/gsd-executor.md"
      to: "get-shit-done/bin/gsd-tools.js"
      via: "Executor writes heartbeat after each task"
      pattern: "heartbeat write"
    - from: "get-shit-done/workflows/execute-phase.md"
      to: "get-shit-done/bin/gsd-tools.js"
      via: "Orchestrator checks for stale heartbeats in monitoring loop"
      pattern: "heartbeat.*check-stale"
---

<objective>
Implement heartbeat mechanism using `.planning/.heartbeats/<agent>.json` files so the orchestrator can detect crashed executors and spawn replacements.

Purpose: If an executor crashes silently, the orchestrator doesn't know and waits indefinitely. Heartbeat monitoring with stale detection enables crash recovery.
Output: New gsd-tools.js heartbeat commands, executor heartbeat writing, and orchestrator stale detection with replacement spawning.
</objective>

<execution_context>
@/Users/naveennegi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/naveennegi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-claude-teams-hardening/02.1-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add heartbeat write/read/check-stale commands to gsd-tools.js</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Add three new subcommands under a `heartbeat` command group:

1. **`heartbeat write <agent-name> --plan <plan_id> --task <current_task>`**
   - Creates/updates `.planning/.heartbeats/<agent-name>.json`
   - Ensures `.planning/.heartbeats/` directory exists
   - Writes JSON: `{ agent: name, plan_id, current_task, timestamp: ISO, epoch: unix_seconds }`
   - Each write overwrites the previous heartbeat for that agent

2. **`heartbeat check-stale --threshold <minutes>`**
   - Reads all `.json` files from `.planning/.heartbeats/`
   - Compares each heartbeat's epoch against current time
   - Default threshold: 15 minutes
   - Returns JSON:
     ```json
     {
       "stale": [
         { "agent": "executor-01", "plan_id": "02.1-01", "last_seen": "ISO", "minutes_ago": 22 }
       ],
       "healthy": [
         { "agent": "executor-02", "plan_id": "02.1-02", "last_seen": "ISO", "minutes_ago": 3 }
       ],
       "has_stale": true
     }
     ```
   - If directory doesn't exist or empty: `{ stale: [], healthy: [], has_stale: false }`

3. **`heartbeat clear`**
   - Removes all files in `.planning/.heartbeats/`
   - Returns `{ cleared: true, files_removed: N }`

Register all three in command dispatch. Use existing error patterns.
  </action>
  <verify>
Run heartbeat commands:
```bash
node gsd-tools.js heartbeat write "executor-01" --plan "02.1-01" --task 1
node gsd-tools.js heartbeat check-stale --threshold 0
node gsd-tools.js heartbeat clear
```
Verify JSON structure. Use threshold 0 to simulate stale detection. Run `npm test`.
  </verify>
  <done>heartbeat write/check-stale/clear commands manage .planning/.heartbeats/ files with stale detection.</done>
</task>

<task type="auto">
  <name>Task 2: Add heartbeat writing to gsd-executor.md and stale detection to execute-phase.md</name>
  <files>agents/gsd-executor.md, get-shit-done/workflows/execute-phase.md</files>
  <action>
In `gsd-executor.md`, in the `<team_communication_protocol>` section under "Executor-Specific Team Behavior", add:

```markdown
### Heartbeat Reporting
- After completing each task, write a heartbeat (can be combined with progress write):
  \```bash
  node /Users/naveennegi/.claude/get-shit-done/bin/gsd-tools.js heartbeat write "{your-executor-name}" --plan "{plan_id}" --task {completed_task_num}
  \```
- Heartbeats confirm to the orchestrator that you are still active
- If the orchestrator sends you a health-check message, respond immediately:
  \```
  SendMessage({ type: "message", recipient: "team-lead",
    content: "ALIVE: executor-{plan_id} is active, working on task {N} of {plan_id}",
    summary: "Health check response: active" })
  \```
```

In `execute-phase.md`, in the "Orchestrator monitoring in team mode" section, add stale heartbeat detection:

```markdown
**Stale heartbeat detection (in monitoring loop):**

\```bash
HEARTBEATS=$(node gsd-tools.js heartbeat check-stale --threshold 15)
\```

If has_stale is true:
  For each stale agent:
    1. Send health-check message:
       \```
       SendMessage({ type: "message", recipient: "{stale_agent}",
         content: "HEALTH_CHECK: Are you still active? Last heartbeat was {minutes_ago} minutes ago.",
         summary: "Health check for {stale_agent}" })
       \```
    2. Wait briefly for response (check for message reply)
    3. If no response after reasonable wait:
       - Log: "Executor {agent} appears crashed (no heartbeat for {minutes_ago} min, no health-check response)"
       - Mark the executor's task as failed in team checkpoint
       - Spawn replacement executor as standalone subagent for that specific plan:
         \```
         Task(subagent_type="gsd-executor", prompt="[same prompt as original executor for plan {plan_id}]")
         \```
       - Note: replacement runs independently, not as team member (team may be partially degraded)
```

At start and end of execution, clear heartbeats:
```bash
node gsd-tools.js heartbeat clear
```
  </action>
  <verify>
Read gsd-executor.md and verify heartbeat writing instructions. Read execute-phase.md and verify stale detection, health-check messaging, and replacement spawning logic. Verify heartbeat clear at start and end.
  </verify>
  <done>Executors write heartbeats. Orchestrator detects stale heartbeats, sends health-checks, and spawns replacement executors for crashed agents.</done>
</task>

</tasks>

<verification>
1. `npm test` passes with no regressions
2. heartbeat write/check-stale/clear commands work correctly
3. gsd-executor.md includes heartbeat writing and health-check response
4. execute-phase.md monitoring loop includes stale detection and replacement spawning
5. Heartbeats cleared at start and end of execution
</verification>

<success_criteria>
Stale executor heartbeats (>15 min) trigger health-check and replacement executor spawning.
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-claude-teams-hardening/02.1-07-SUMMARY.md`
</output>
