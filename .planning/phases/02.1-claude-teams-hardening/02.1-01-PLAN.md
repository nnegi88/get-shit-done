---
phase: 02.1-claude-teams-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/bin/gsd-tools.js
  - get-shit-done/workflows/execute-phase.md
  - agents/gsd-planner.md
autonomous: true

must_haves:
  truths:
    - "A plan blocked only by Plan A starts immediately when Plan A completes, even if unrelated Plan B in the same wave is still running"
    - "Wave assignments are still computed but serve as a fallback when depends_on is empty"
    - "Existing characterization tests pass with no regressions"
  artifacts:
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "depends_on parsing in cmdPhasePlanIndex"
      contains: "depends_on"
    - path: "get-shit-done/workflows/execute-phase.md"
      provides: "Granular dependency-based task creation in team mode"
      contains: "addBlockedBy"
    - path: "agents/gsd-planner.md"
      provides: "Updated planning guidance for depends_on usage"
      contains: "depends_on"
  key_links:
    - from: "get-shit-done/bin/gsd-tools.js"
      to: "get-shit-done/workflows/execute-phase.md"
      via: "phase-plan-index JSON output includes depends_on per plan"
      pattern: "depends_on"
---

<objective>
Implement granular task dependencies using `depends_on` metadata from PLAN.md frontmatter, replacing the rigid wave-level blocking where all wave N+1 tasks wait for ALL wave N tasks.

Purpose: Eliminate unnecessary blocking — if Plan C only depends on Plan A, it should start as soon as Plan A completes, not wait for unrelated Plan B in the same wave.
Output: Updated gsd-tools.js plan index, execute-phase.md team task creation, and planner guidance.
</objective>

<execution_context>
@/Users/naveennegi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/naveennegi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add depends_on parsing to cmdPhasePlanIndex in gsd-tools.js</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
In `cmdPhasePlanIndex` (around line 1783), after extracting frontmatter with `extractFrontmatter(content)`:

1. Parse `depends_on` from frontmatter as an array of plan IDs:
   ```js
   let dependsOn = [];
   if (fm['depends-on'] || fm['depends_on']) {
     const raw = fm['depends-on'] || fm['depends_on'];
     dependsOn = Array.isArray(raw) ? raw.map(String) : [String(raw)];
   }
   ```

2. Add `depends_on: dependsOn` to the plan object alongside existing `wave`, `autonomous`, `objective`, `files_modified`, etc.

3. In the output result object, add a new field `dependency_graph` that maps each plan ID to its depends_on list for quick lookup by the orchestrator:
   ```js
   const dependencyGraph = {};
   for (const plan of plans) {
     dependencyGraph[plan.id] = plan.depends_on;
   }
   ```
   Add `dependency_graph` to the result object.

Do NOT change the existing `waves` grouping — it remains as fallback. The `depends_on` field is additive.
  </action>
  <verify>
Run `node /Users/naveennegi/.claude/get-shit-done/bin/gsd-tools.js phase-plan-index "02"` and verify the output JSON includes `depends_on` arrays for each plan and a `dependency_graph` field. Run `npm test` to confirm no regressions.
  </verify>
  <done>phase-plan-index output includes `depends_on` per plan and `dependency_graph` in result. All existing tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Update execute-phase.md team mode to use granular depends_on for TaskUpdate addBlockedBy</name>
  <files>get-shit-done/workflows/execute-phase.md, agents/gsd-planner.md</files>
  <action>
In `execute-phase.md`, section "TEAM MODE" (around line 88-109), change the task creation logic:

**Current behavior:** Wave N+1 tasks are blocked by ALL tasks from previous wave.
**New behavior:** Each task is blocked only by tasks corresponding to its `depends_on` plan IDs.

Replace the task creation pseudocode:
```
For each plan (in dependency order):
  task = TaskCreate({
    subject: "Execute Plan {plan_id}: {plan_objective}",
    description: "Execute {plan_file}. Commit each task atomically. Create SUMMARY.md.",
    activeForm: "Executing plan {plan_id}"
  })
  # Use depends_on from plan index instead of wave-level blocking
  If plan.depends_on is not empty:
    # Map depends_on plan IDs to their corresponding task IDs
    blocked_by = [task_id_map[dep_plan_id] for dep_plan_id in plan.depends_on]
    TaskUpdate({ taskId: task.id, addBlockedBy: blocked_by })
  # Track plan_id -> task_id mapping for downstream dependency resolution
  task_id_map[plan_id] = task.id
```

Also update the wave completion reporting to reflect that plans may complete out of wave order (since granular deps allow earlier starts).

Add a note: "When depends_on is empty for all plans, falls back to wave-level blocking as before."

In `agents/gsd-planner.md`, in the `<dependency_graph>` section, add a paragraph emphasizing that `depends_on` in plan frontmatter now drives actual execution ordering (not just wave grouping). Wave numbers remain for documentation and fallback but `depends_on` is the primary mechanism.
  </action>
  <verify>
Read the updated execute-phase.md and verify the team mode task creation uses depends_on-based blocking. Read gsd-planner.md and verify the updated guidance. Grep for "depends_on" in both files.
  </verify>
  <done>Team mode creates tasks with addBlockedBy based on depends_on plan IDs instead of wave-level blocking. Planner guidance updated to emphasize depends_on as primary execution ordering mechanism.</done>
</task>

</tasks>

<verification>
1. `npm test` passes with no regressions
2. `phase-plan-index` output for Phase 02 includes depends_on and dependency_graph
3. execute-phase.md team mode creates tasks with granular depends_on blocking
4. gsd-planner.md documents depends_on as primary execution ordering
</verification>

<success_criteria>
Plans with depends_on metadata create precise task dependency chains instead of wave-level blocking, so a plan starts as soon as its specific predecessors complete.
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-claude-teams-hardening/02.1-01-SUMMARY.md`
</output>
