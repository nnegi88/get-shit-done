---
phase: 02.1-claude-teams-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/bin/gsd-tools.js
  - get-shit-done/workflows/plan-phase.md
  - get-shit-done/workflows/execute-phase.md
autonomous: true

must_haves:
  truths:
    - "Same-wave plans with overlapping files_modified produce a warning before execution begins"
    - "The warning identifies which plans conflict and on which files"
    - "Execution can proceed despite warnings (not a blocker, just a notification)"
  artifacts:
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "validate file-conflicts command"
      contains: "file-conflicts"
    - path: "get-shit-done/workflows/execute-phase.md"
      provides: "File conflict validation gate before execution"
      contains: "file-conflicts"
  key_links:
    - from: "get-shit-done/bin/gsd-tools.js"
      to: "get-shit-done/workflows/execute-phase.md"
      via: "validate file-conflicts command called before team/wave execution"
      pattern: "validate.*file-conflicts"
---

<objective>
Add file conflict detection that cross-references `files_modified` arrays within same-wave plans and warns before execution begins.

Purpose: Two same-wave plans modifying the same file can cause merge conflicts or overwrites. Detection before execution lets the orchestrator warn and optionally resequence.
Output: New gsd-tools.js validate command and integration into execute-phase.md and plan-phase.md validation gates.
</objective>

<execution_context>
@/Users/naveennegi/.claude/get-shit-done/workflows/execute-plan.md
@/Users/naveennegi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validate file-conflicts command to gsd-tools.js</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Add a new subcommand `validate file-conflicts <phase>` to gsd-tools.js:

1. Register in the command dispatch (same pattern as existing `validate` subcommands). Add it near the existing `verify` or `validate` command handlers.

2. Implementation:
   - Use `cmdPhasePlanIndex` logic (or call it internally) to get all plans with their `wave` and `files_modified` arrays
   - Group plans by wave
   - Within each wave, compare every pair of plans' `files_modified` arrays
   - If any overlap found, record: `{ wave, plan_a, plan_b, conflicting_files: [...] }`
   - Output JSON: `{ has_conflicts: boolean, conflicts: [...], summary: "N conflicts in M waves" }`

3. Handle edge cases:
   - Plans with empty `files_modified` — skip comparison
   - Normalize file paths (trim whitespace, consistent separators)
   - Single-plan waves — no conflicts possible, skip

Example output:
```json
{
  "has_conflicts": true,
  "conflicts": [
    {
      "wave": 1,
      "plan_a": "02.1-01",
      "plan_b": "02.1-04",
      "conflicting_files": ["get-shit-done/bin/gsd-tools.js"]
    }
  ],
  "summary": "1 conflict found in wave 1"
}
```
  </action>
  <verify>
Create a temporary test phase with two plans having overlapping files_modified and run `node /Users/naveennegi/.claude/get-shit-done/bin/gsd-tools.js validate file-conflicts <test-phase>`. Verify conflicts are detected. Run `npm test` for regressions.
  </verify>
  <done>validate file-conflicts command detects overlapping files_modified within same-wave plans and outputs structured JSON.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate file conflict validation into execute-phase.md and plan-phase.md</name>
  <files>get-shit-done/workflows/execute-phase.md, get-shit-done/workflows/plan-phase.md</files>
  <action>
In `execute-phase.md`, add a validation step after `discover_and_group_plans` and before `execute_waves`:

```markdown
<step name="validate_file_conflicts">
Run file conflict detection:

\```bash
CONFLICTS=$(node /Users/naveennegi/.claude/get-shit-done/bin/gsd-tools.js validate file-conflicts "${PHASE_NUMBER}")
\```

**If `has_conflicts` is true:**
Display warning:
\```
⚠️  FILE CONFLICT WARNING

The following same-wave plans modify overlapping files:

| Wave | Plan A | Plan B | Conflicting Files |
|------|--------|--------|-------------------|
| {wave} | {plan_a} | {plan_b} | {files} |

This may cause merge conflicts during parallel execution.
\```

Ask user: "Continue with parallel execution?" or "Resequence conflicting plans?"

**If `has_conflicts` is false:** Continue silently.
</step>
```

In `plan-phase.md`, add a note in the planner prompt's `<quality_gate>` section:
```
- [ ] No file conflicts within same-wave plans (validate with gsd-tools)
```
  </action>
  <verify>
Read execute-phase.md and verify the file conflict validation step exists between discover_and_group_plans and execute_waves. Read plan-phase.md and verify the quality gate mention.
  </verify>
  <done>execute-phase.md includes file conflict validation gate with user warning. plan-phase.md quality gate references file conflict check.</done>
</task>

</tasks>

<verification>
1. `npm test` passes with no regressions
2. `validate file-conflicts` command produces correct JSON for overlapping and non-overlapping scenarios
3. execute-phase.md has validation gate between plan discovery and execution
4. plan-phase.md quality gate mentions file conflict check
</verification>

<success_criteria>
Same-wave plans with overlapping files_modified are detected and warned about before execution begins.
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-claude-teams-hardening/02.1-02-SUMMARY.md`
</output>
